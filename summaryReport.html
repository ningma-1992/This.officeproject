<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reports | IdeaHub Dashboard</title>

  <!-- Google Fonts (Karla) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Karla:ital,wght@0,200..800;1,200..800&display=swap"
    rel="stylesheet"
  />

  <!-- Your original CSS files (unchanged) -->
  <link rel="stylesheet" href="css/common.css" />
  <link rel="stylesheet" href="css/reports.css" />
  <link rel="stylesheet" href="css/index.css" />

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Chart.js (for doughnut) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <!-- SheetJS (XLSX) for Excel export -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
    defer
  ></script>

  <style>
    body {
      font-family: 'Karla', sans-serif;
      background: #f8f9fa;
      padding: 30px;
    }
    .Chart_container {
      width: 100%;
      max-width: 400px;
      margin: auto;
    }
  </style>
</head>
<body>
  <!-- ──────────────────────────────────────────────────── -->
  <!-- SIDEBAR (UNCHANGED) -->
  <!-- ──────────────────────────────────────────────────── -->
  <nav class="sidebar">
    <div class="logo">
      <img src="assets/logo.svg" alt="IdeaHub Logo" />
    </div>
    <ul class="links-wrapper">
      <li><a class="nav-link" href="index.html">Home</a></li>
      <li><a class="nav-link" href="browse-ideas.html">Browse Ideas</a></li>
      <li><a class="nav-link" href="my-ideas.html">My Drafts</a></li>
      <li><a class="nav-link" href="my-activity.html">My Activity</a></li>
      <li><a class="nav-link" href="teamReport.html">Team Reports</a></li>
      <li><a class="nav-link" href="summaryReport.html">Summary Reports</a></li>
    </ul>
  </nav>

  <!-- ──────────────────────────────────────────────────── -->
  <!-- MAIN CONTENT (original .main-content2) -->
  <!-- ──────────────────────────────────────────────────── -->
  <main class="main-content2">
    <div class="header-top mb-4">
      <h3>Summary Reports</h3>
    </div>
    <br>

    <!-- Top summary cards -->
    <div class="row mb-4 card-wrapper-reports">
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <div class="card-title h5">Total Ideas</div>
            <p class="card-text" id="totalIdeasCount">0</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <div class="card-title h5">Managers</div>
            <p class="card-text" id="totalManagers">0</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <div class="card-title h5">Months</div>
            <p class="card-text" id="totalMonths">0</p>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <div class="card-title h5">Categories</div>
            <p class="card-text">3</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Manager + Month selector -->
    <div class="row mb-4 card-wrapper-reports">
      <div class="col-md-4">
        <label for="managerSelect" class="form-label">Select Manager:</label>
        <select id="managerSelect" class="form-select">
          <option value="" disabled selected>Select a manager</option>
          <option value="john">John Doe</option>
          <option value="jane">Jane Smith</option>
          <option value="mark">Mark Johnson</option>
          <option value="sarah">Sarah Lee</option>
          <option value="michael">Michael Brown</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="monthSelect" class="form-label">Select Month:</label>
        <select id="monthSelect" class="form-select" disabled>
          <option value="" disabled selected>Select a month</option>
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end justify-content-end">
        <button id="exportBtn" class="btn btn-success" disabled>
          Export Excel
        </button>
      </div>
    </div>

    <!-- Table for showing manager/month breakdown -->
    <div class="row mb-4 card-wrapper-reports">
      <div class="col-12">
        <table class="table table-bordered text-center">
          <thead class="table-light">
            <tr>
              <th>Manager</th>
              <th>Month</th>
              <th>Transport</th>
              <th>Facility</th>
              <th>Operation</th>
            </tr>
          </thead>
          <tbody>
            <tr id="dataRow">
              <td id="managerName">—</td>
              <td id="monthName">—</td>
              <td id="glands">0</td>
              <td id="vitamins">0</td>
              <td id="herbal">0</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Totals summary cards (All months for that manager) -->
    <div class="row text-center mb-4 card-wrapper-reports">
      <div class="col-md-6 summary">
        <div class="card p-3 mb-3">
          <h6>Total Submitted (Selected Months)</h6>
          <h4 id="totalSubmittedAll">0</h4>
        </div>
        <div class="card p-3 mb-3">
          <h6>Approved (Selected Months)</h6>
          <h4 id="totalApprovedAll">0</h4>
        </div>
        <div class="card p-3 mb-3">
          <h6>In-Preview (Selected Months)</h6>
          <h4 id="totalPreviewAll">0</h4>
        </div>
        <div class="card p-3 mb-3">
          <h6>Rejected (Selected Months)</h6>
          <h4 id="totalRejectedAll">0</h4>
        </div>
      </div>

      <!-- Totals for Selected Month + Doughnut chart -->
      <div class="col-md-6">
        <div class="text-center mb-3 d-flex justify-content-between">
          <h5>
            Total Submitted Ideas<br />
            (Selected Month):
            <span
              id="totalSubmittedMonth"
              style="margin-left: 10px; color: #0a77d0;"
              >0</span
            >
          </h5>
        </div>
        <div class="mb-4 Chart_container">
          <canvas id="statusChart"></canvas>
        </div>
      </div>
    </div>
  </main>

  <!-- ──────────────────────────────────────────────────── -->
  <!-- JAVASCRIPT (at bottom) -->
  <!-- ──────────────────────────────────────────────────── -->
  <script>
    // ──────────────────────────────────────────────────────
    // Data structure: manager → category → month → { submitted, status }
    // ──────────────────────────────────────────────────────
    const dummyData2 = {
      john: {
        Transport: {
          january: {
            submitted: { idea1: 22, idea2: 18 },
            status: { preview: 8, approved: 25, rejected: 6 },
          },
          february: {
            submitted: { idea1: 20, idea2: 17 },
            status: { preview: 7, approved: 22, rejected: 5 },
          },
        },
        Facility: {
          january: {
            submitted: { idea1: 25, idea2: 20 },
            status: { preview: 10, approved: 28, rejected: 7 },
          },
          march: {
            submitted: { idea1: 19, idea2: 16 },
            status: { preview: 6, approved: 24, rejected: 4 },
          },
        },
        Operation: {
          april: {
            submitted: { idea1: 21, idea2: 17 },
            status: { preview: 9, approved: 26, rejected: 5 },
          },
        },
      },
      jane: {
        Operation: {
          january: {
            submitted: { idea1: 24, idea2: 19 },
            status: { preview: 8, approved: 30, rejected: 6 },
          },
          april: {
            submitted: { idea1: 23, idea2: 17 },
            status: { preview: 7, approved: 28, rejected: 5 },
          },
        },
        Transport: {
          march: {
            submitted: { idea1: 20, idea2: 15 },
            status: { preview: 6, approved: 25, rejected: 4 },
          },
        },
        Facility: {
          february: {
            submitted: { idea1: 18, idea2: 16 },
            status: { preview: 5, approved: 22, rejected: 3 },
          },
        },
      },
      mark: {
        Transport: {
          march: {
            submitted: { idea1: 21, idea2: 17 },
            status: { preview: 7, approved: 26, rejected: 5 },
          },
        },
        Facility: {
          february: {
            submitted: { idea1: 22, idea2: 18 },
            status: { preview: 6, approved: 24, rejected: 4 },
          },
        },
        Operation: {
          june: {
            submitted: { idea1: 20, idea2: 17 },
            status: { preview: 5, approved: 23, rejected: 3 },
          },
        },
      },
      sarah: {
        Transport: {
          january: {
            submitted: { idea1: 18, idea2: 17 },
            status: { preview: 5, approved: 22, rejected: 4 },
          },
          february: {
            submitted: { idea1: 19, idea2: 16 },
            status: { preview: 6, approved: 23, rejected: 5 },
          },
          april: {
            submitted: { idea1: 18, idea2: 15 },
            status: { preview: 5, approved: 21, rejected: 4 },
          },
        },
        Facility: {
          may: {
            submitted: { idea1: 19, idea2: 15 },
            status: { preview: 5, approved: 22, rejected: 4 },
          },
        },
      },
      michael: {
        Operation: {
          february: {
            submitted: { idea1: 17, idea2: 16 },
            status: { preview: 4, approved: 20, rejected: 3 },
          },
          march: {
            submitted: { idea1: 18, idea2: 17 },
            status: { preview: 5, approved: 22, rejected: 4 },
          },
          may: {
            submitted: { idea1: 17, idea2: 15 },
            status: { preview: 4, approved: 21, rejected: 3 },
          },
        },
        Facility: {
          june: {
            submitted: { idea1: 19, idea2: 16 },
            status: { preview: 5, approved: 23, rejected: 4 },
          },
        },
      },
    };

    // ──────────────────────────────────────────────────────
    // Grab references to DOM elements
    // ──────────────────────────────────────────────────────
    const managerSelect         = document.getElementById('managerSelect');
    const monthSelect           = document.getElementById('monthSelect');
    const exportBtn             = document.getElementById('exportBtn');

    const managerNameEl         = document.getElementById('managerName');
    const monthNameEl           = document.getElementById('monthName');
    const transportEl           = document.getElementById('glands');
    const facilityEl            = document.getElementById('vitamins');
    const operationEl           = document.getElementById('herbal');

    const totalIdeasCountEl     = document.getElementById('totalIdeasCount');
    const totalManagersEl       = document.getElementById('totalManagers');
    const totalMonthsEl         = document.getElementById('totalMonths');

    const totalSubmittedAllEl   = document.getElementById('totalSubmittedAll');
    const totalApprovedAllEl    = document.getElementById('totalApprovedAll');
    const totalPreviewAllEl     = document.getElementById('totalPreviewAll');
    const totalRejectedAllEl    = document.getElementById('totalRejectedAll');

    const totalSubmittedMonthEl = document.getElementById('totalSubmittedMonth');

    let statusChart = null;

    // ──────────────────────────────────────────────────────
    // Utility: sort month names in calendar order
    // ──────────────────────────────────────────────────────
    const monthOrder = [
      'january','february','march','april','may','june',
      'july','august','september','october','november','december'
    ];
    function sortMonths(a, b) {
      return monthOrder.indexOf(a) - monthOrder.indexOf(b);
    }

    // ──────────────────────────────────────────────────────
    // On page load, compute and fill in the “default” aggregates
    // ──────────────────────────────────────────────────────
    document.addEventListener('DOMContentLoaded', () => {
      // 1) count managers
      const managerKeys = Object.keys(dummyData2);
      const numManagers = managerKeys.length;
      totalManagersEl.textContent = numManagers;

      // 2) gather all unique months
      const monthsSet = new Set();
      managerKeys.forEach(key => {
        const mgrData = dummyData2[key];
        Object.values(mgrData).forEach(catObj => {
          Object.keys(catObj).forEach(mth => monthsSet.add(mth));
        });
      });
      const uniqueMonths = Array.from(monthsSet).sort(sortMonths);
      const numMonths = uniqueMonths.length;
      totalMonthsEl.textContent = numMonths;

      // 3) compute grand totals per category & grand total
      let totalTransport = 0;
      let totalFacility  = 0;
      let totalOperation = 0;
      let grandTotalIdeas = 0;

      managerKeys.forEach(key => {
        const mgrData = dummyData2[key];
        ['Transport','Facility','Operation'].forEach(catName => {
          const catObj = mgrData[catName];
          if (!catObj) return;
          Object.values(catObj).forEach(monthObj => {
            const subCount = Object.values(monthObj.submitted).reduce((a,b) => a + b, 0);
            grandTotalIdeas += subCount;
            if (catName === 'Transport') totalTransport += subCount;
            if (catName === 'Facility')  totalFacility  += subCount;
            if (catName === 'Operation') totalOperation += subCount;
          });
        });
      });

      totalIdeasCountEl.textContent = grandTotalIdeas;

      // Fill the “default” table row:
      managerNameEl.textContent  = numManagers;
      monthNameEl.textContent    = numMonths;
      transportEl.textContent    = totalTransport;
      facilityEl.textContent     = totalFacility;
      operationEl.textContent    = totalOperation;

      // Disable month dropdown and export button initially
      monthSelect.disabled = true;
      exportBtn.disabled   = true;
    });

    // ──────────────────────────────────────────────────────
    // When “Select Manager” changes:
    //   • rebuild months for that manager
    //   • clear table/chart
    //   • reset all four “Selected Months” cards to 0
    //   • disable Export until month is picked
    // ──────────────────────────────────────────────────────
    managerSelect.addEventListener('change', () => {
      const mgrKey = managerSelect.value;

      // Reset month dropdown + table/chart + export button
      monthSelect.innerHTML = '<option value="" disabled selected>Select a month</option>';
      monthSelect.disabled  = true;
      resetTableRow();
      exportBtn.disabled    = true;

      // Reset the four “Selected Months” totals to 0
      totalSubmittedAllEl.textContent = '0';
      totalApprovedAllEl.textContent  = '0';
      totalPreviewAllEl.textContent   = '0';
      totalRejectedAllEl.textContent  = '0';

      if (!mgrKey) return;

      // 1) gather that manager’s months
      const managerData = dummyData2[mgrKey];
      const monthsSet = new Set();
      Object.values(managerData).forEach(catObj => {
        Object.keys(catObj).forEach(mth => monthsSet.add(mth));
      });
      const sortedMonths = Array.from(monthsSet).sort(sortMonths);
      sortedMonths.forEach(mth => {
        const opt = document.createElement('option');
        opt.value       = mth;
        opt.textContent = mth.charAt(0).toUpperCase() + mth.slice(1);
        monthSelect.appendChild(opt);
      });
      monthSelect.disabled = false;

      // (Do NOT compute the four “Selected Months” totals here anymore)
    });

    // ──────────────────────────────────────────────────────
    // When “Select Month” changes:
    //   • fill table row + “Selected Month” total + chart
    //   • compute and fill the four “Selected Months” totals
    //   • enable export button
    // ──────────────────────────────────────────────────────
    monthSelect.addEventListener('change', () => {
      const mgrKey = managerSelect.value;
      const mthKey = monthSelect.value;
      if (!mgrKey || !mthKey) {
        resetTableRow();
        exportBtn.disabled = true;
        return;
      }

      const managerData = dummyData2[mgrKey];
      function getCategoryTotals(catName) {
        const catObj = managerData[catName];
        if (!catObj || !catObj[mthKey]) {
          return { submitted: 0, preview: 0, approved: 0, rejected: 0 };
        }
        const sub = Object.values(catObj[mthKey].submitted).reduce((a,b) => a + b, 0);
        return {
          submitted: sub,
          preview:   catObj[mthKey].status.preview,
          approved:  catObj[mthKey].status.approved,
          rejected:  catObj[mthKey].status.rejected,
        };
      }

      const tTot = getCategoryTotals('Transport');
      const fTot = getCategoryTotals('Facility');
      const oTot = getCategoryTotals('Operation');

      managerNameEl.textContent = managerSelect.options[managerSelect.selectedIndex].text;
      monthNameEl.textContent   = mthKey.charAt(0).toUpperCase() + mthKey.slice(1);
      transportEl.textContent   = tTot.submitted;
      facilityEl.textContent    = fTot.submitted;
      operationEl.textContent   = oTot.submitted;

      // “Selected Month” total (for the doughnut header)
      const monthSum = tTot.submitted + fTot.submitted + oTot.submitted;
      totalSubmittedMonthEl.textContent = monthSum;

      // Doughnut chart data = status for that month
      const chartData = [
        tTot.preview + fTot.preview + oTot.preview,
        tTot.approved + fTot.approved + oTot.approved,
        tTot.rejected + fTot.rejected + oTot.rejected,
      ];
      updateStatusChart(chartData);

      // ──────────────────────────────────────────────────
      // Now compute the four “Selected Months” totals
      // (i.e. sum of preview/approved/rejected across all months
      //  for the chosen manager)
      // ──────────────────────────────────────────────────
      let sumSubs = 0, sumAppr = 0, sumPrev = 0, sumRej = 0;
      Object.values(managerData).forEach(catObj => {
        Object.values(catObj).forEach(mthObj => {
          const monthlySubs = Object.values(mthObj.submitted).reduce((a,b) => a + b, 0);
          sumSubs += monthlySubs;
          sumAppr += mthObj.status.approved;
          sumPrev += mthObj.status.preview;
          sumRej  += mthObj.status.rejected;
        });
      });

      totalSubmittedAllEl.textContent = sumSubs;
      totalApprovedAllEl.textContent  = sumAppr;
      totalPreviewAllEl.textContent   = sumPrev;
      totalRejectedAllEl.textContent  = sumRej;

      exportBtn.disabled = false;
    });

    // ──────────────────────────────────────────────────────
    // Export the currently displayed row to Excel
    // ──────────────────────────────────────────────────────
    exportBtn.addEventListener('click', () => {
      const mgrName   = managerNameEl.textContent;
      const monthName = monthNameEl.textContent;
      const tVal      = transportEl.textContent;
      const fVal      = facilityEl.textContent;
      const oVal      = operationEl.textContent;

      if (
        !mgrName ||
        !monthName ||
        (tVal === '0' && fVal === '0' && oVal === '0')
      ) {
        return alert('No data to export for the selected manager/month.');
      }

      const aoa = [
        ['Manager', 'Month', 'Transport', 'Facility', 'Operation'],
        [mgrName, monthName, tVal, fVal, oVal],
      ];
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Report');
      XLSX.writeFile(wb, `${mgrName}_${monthName}_report.xlsx`);
    });

    // ──────────────────────────────────────────────────────
    // Draw or update Chart.js doughnut
    // ──────────────────────────────────────────────────────
    function updateStatusChart(dataArr) {
      const ctx = document.getElementById('statusChart').getContext('2d');
      if (!statusChart) {
        statusChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['In-Preview', 'Approved', 'Rejected'],
            datasets: [
              {
                data: dataArr,
                backgroundColor: ['#ffc107', '#28a745', '#dc3545'],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: { display: true, text: 'Idea Status Breakdown' },
            },
          },
        });
      } else {
        statusChart.data.datasets[0].data = dataArr;
        statusChart.update();
      }
    }

    // ──────────────────────────────────────────────────────
    // Reset helpers
    // ──────────────────────────────────────────────────────
    function resetTableRow() {
      managerNameEl.textContent   = '—';
      monthNameEl.textContent     = '—';
      transportEl.textContent     = '0';
      facilityEl.textContent      = '0';
      operationEl.textContent     = '0';
      totalSubmittedMonthEl.textContent = '0';
      if (statusChart) updateStatusChart([0, 0, 0]);
    }
  </script>

  <!-- Bootstrap JS (unchanged) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    defer
  ></script>
</body>
</html>
